(()=>{"use strict";async function e({withAudio:e}={}){return await navigator.mediaDevices.getUserMedia({video:!0,audio:!!e})}async function t(e,t){e.srcObject=t}async function a(e,t){t.getTracks().forEach((a=>{e.addTrack(a,t),console.log("add-local-track-done")}))}const n="47.112.231.67:2024",o=document.querySelector("#createRoom"),c=document.querySelector("#joinRoom");o.addEventListener("click",(async()=>{await(async()=>{const o=new WebSocket(`wss://${n}`),c=document.getElementById("localVideo"),i=document.getElementById("remoteVideo"),s=document.querySelector("#room"),d=new RTCPeerConnection;let r,l;const w=Math.floor(1e3*Math.random()).toString();s.textContent=`Room: ${w}`,WebSocket.prototype.subscribe=({type:e,data:t})=>{try{o.send(JSON.stringify({type:e,...t}))}catch(e){console.warn(`WS_CONNECT_ERROR -- ${e.message}`)}},d.ontrack=async e=>{console.log("create-on-track",e.streams);const t=e.streams[0];i.srcObject=t},d.onicecandidate=async e=>{const t=e.candidate;t&&!l&&(l=t,console.log(t,"fetch-ice-candidate"),o.subscribe({type:"candidate-call",data:{id:w,candidate:t}}))},d.addEventListener("icegatheringstatechange",(e=>{switch(d.iceGatheringState){case"new":console.log("new");break;case"gathering":console.log("gathering");break;case"complete":console.log("complete")}})),o.addEventListener("open",(()=>{o.subscribe({type:"init",data:{id:w}})})),o.addEventListener("message",(async e=>{const t=JSON.parse(e.data),{type:a}=t;"answer-sdp"===a&&(await d.setRemoteDescription(t.SDP),console.log("remote-sdp-set-done",t.SDP)),"remote-id"===a&&(r=t.id),"candidate"===a&&d.addIceCandidate(t.candidate),"remote-candidate-reply"===a&&d.addIceCandidate(t.candidate)}));const y=await e({withAudio:!0}),m=await e({withAudio:!1});await t(c,m),await a(d,y);const u=await async function(e){const t=await e.createOffer();return console.log(t,"create-local-SDP"),await e.setLocalDescription(t),t}(d);o.subscribe({type:"switch-answer-with-offer",data:{SDP:u,id:w}})})()})),c.addEventListener("click",(async()=>{await(async()=>{const o=new WebSocket(`wss://${n}`),c=document.getElementById("localVideo"),i=document.querySelector("#join-ipt"),s=document.querySelector("#room"),d=new RTCPeerConnection,r=Math.floor(1e3*Math.random()),l=i.value.toString();s.textContent=`Room: ${l}`,WebSocket.prototype.subscribe=({type:e,data:t})=>{o.send(JSON.stringify({type:e,...t}))},d.ontrack=async e=>{console.log("join-on-track",e.streams);const t=document.getElementById("remoteVideo"),a=await e.streams[0];t.srcObject=a},d.onicecandidate=async e=>{const t=e.candidate;t&&o.subscribe({type:"candidate-remote",data:{target:l,candidate:t}})},o.addEventListener("open",(()=>{o.subscribe({type:"init",data:{id:r}})})),o.addEventListener("message",(async e=>{const t=JSON.parse(e.data);if("offer-sdp"===t.type){const e=t.SDP,a=t.candidate;await d.setRemoteDescription(e),await d.addIceCandidate(a);const n=await async function(e,t){await e.setRemoteDescription(t);const a=await e.createAnswer();return await e.setLocalDescription(a),a}(d,e);o.subscribe({type:"reply-answer",data:{id:l,SDP:n}})}}));const w=await e({withAudio:!0}),y=await e({withAudio:!1});await t(c,y),await a(d,w),await o.subscribe({type:"fetch-offer",data:{target:l,id:r}})})()}))})();